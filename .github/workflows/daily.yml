name: Daily refresh
on:
  schedule:
    - cron: "0 15 * * *"
  push:
    branches:
      - daily
  workflow_dispatch:
    inputs:
      short_circuit:
        type: boolean
        description: "When set, skip stages when their inputs haven't run or changed"
        default: true
jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.GHA_DEPLOY_KEY }}
      - uses: actions/setup-python@v4
        with:
          python-version: 3.9
          cache: pip
      - run: pip install -e .
      - name: Configure Git author
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'ryan-williams@users.noreply.github.com'
      - id: refresh_data
        run: njsp -cc refresh_data
      - id: update_pqts
        if: steps.refresh_data.outputs.sha || inputs.short_circuit != 'true'
        run: njsp -cc update_pqts
      - id: update_plots
        if: steps.update_pqts.outputs.sha || inputs.short_circuit != 'true'
        run: njsp -cc update_plots
      - id: build_www
        if: steps.update_plots.outputs.sha || inputs.short_circuit != 'true'
        run: echo "run=1" >> $GITHUB_OUTPUT
      - if: steps.build_www.outputs.run
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: npm
          cache-dependency-path: www/yarn.lock
      - if: steps.build_www.outputs.run
        name: npm install, build, export
        run: |
          cd www
          npm install
          npm run gha-export
      - if: steps.build_www.outputs.run
        name: Deploy to GH Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: www/out
    outputs:
      update_pqts: ${{ steps.update_pqts.outputs.sha }}
  post:
    name: Call Slack-post workflow
    needs: refresh
    if: needs.refresh.outputs.update_pqts != ''
    uses: ./.github/workflows/slack-test.yml
    with:
      commits: ${{ needs.refresh.outputs.update_pqts }}
    secrets: inherit
